<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data noupdate="0">

    <!-- Sueldo Base (igual que antes) -->
    <record id="hr_salary_rule_chile_sueldo_base" model="hr.salary.rule">
      <field name="name">Sueldo Base</field>
      <field name="code">SUELDO</field>
      <field name="sequence">10</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute">result = (contract.wage or 0.0)</field>
    </record>

    <!-- Gratificación Legal (condición desde indicadores; sin usar min()) -->
    <record id="hr_salary_rule_chile_gratificacion" model="hr.salary.rule">
      <field name="name">Gratificación Legal</field>
      <field name="code">GRATIFICACION</field>
      <field name="sequence">15</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="condition_select">python</field>
      <field name="condition_python">
        <![CDATA[
result = bool(payslip and payslip.indicadores_id and payslip.indicadores_id.gratificacion_legal)
        ]]>
      </field>
      <field name="amount_select">code</field>
      <field name="amount_python_compute">
        <![CDATA[
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False
# 25% del sueldo con tope 4.75 UTM del periodo
base25 = wage * 0.25
tope = (indic.utm * 4.75) if (indic and indic.utm) else 0.0
result = base25 if (tope == 0.0 or base25 <= tope) else tope
        ]]>
      </field>
    </record>

    <!-- AFP (aplica tope imponible AFP en UF * UF) -->
    <record id="hr_salary_rule_chile_afp" model="hr.salary.rule">
      <field name="name">AFP</field>
      <field name="code">AFP</field>
      <field name="sequence">20</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute">
        <![CDATA[
result = 0.0
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# Tope AFP en pesos (UF * valor UF)
if indic and indic.tope_imponible_afp and indic.uf:
    tope = indic.tope_imponible_afp * indic.uf
    if wage > tope:
        wage = tope

tasa = (indic.tasa_afp_capital if (indic and indic.tasa_afp_capital) else 0.0)
result = -(wage * (tasa / 100.0))
        ]]>
      </field>
    </record>

    <!-- SIS (mismo tope que AFP) -->
    <record id="hr_salary_rule_chile_sis" model="hr.salary.rule">
      <field name="name">SIS</field>
      <field name="code">SIS</field>
      <field name="sequence">25</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute">
        <![CDATA[
result = 0.0
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# Tope AFP en pesos
if indic and indic.tope_imponible_afp and indic.uf:
    tope = indic.tope_imponible_afp * indic.uf
    if wage > tope:
        wage = tope

tasa = (indic.tasa_sis_capital if (indic and indic.tasa_sis_capital) else 0.0)
result = -(wage * (tasa / 100.0))
        ]]>
      </field>
    </record>

    <!-- Salud (Fonasa/Isapre - tope salud en UF * UF) -->
    <record id="hr_salary_rule_chile_salud" model="hr.salary.rule">
      <field name="name">Salud</field>
      <field name="code">SALUD</field>
      <field name="sequence">30</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute">
        <![CDATA[
result = 0.0
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# Tope Salud en pesos
if indic and indic.tope_imponible_salud and indic.uf:
    tope = indic.tope_imponible_salud * indic.uf
    if wage > tope:
        wage = tope

# Si usas Fonasa desde indicadores (p.ej. 7.0)
tasa = (indic.fonasa if (indic and indic.fonasa) else 0.0)
result = -(wage * (tasa / 100.0))
        ]]>
      </field>
    </record>

    <!-- Seguro Cesantía Trabajador (tope SC en UF * UF) -->
    <record id="hr_salary_rule_chile_sc_trabajador" model="hr.salary.rule">
      <field name="name">Seguro Cesantía Trabajador</field>
      <field name="code">SC_TRAB</field>
      <field name="sequence">35</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute">
        <![CDATA[
result = 0.0
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# Tope SC en pesos
if indic and indic.tope_imponible_seguro_cesantia and indic.uf:
    tope = indic.tope_imponible_seguro_cesantia * indic.uf
    if wage > tope:
        wage = tope

tasa = (indic.contrato_plazo_indefinido_trabajador if (indic and indic.contrato_plazo_indefinido_trabajador) else 0.0)
result = -(wage * (tasa / 100.0))
        ]]>
      </field>
    </record>

    <!-- Seguro Cesantía Empleador (costo empleador; tu categoría puede ser distinta) -->
    <record id="hr_salary_rule_chile_sc_empleador" model="hr.salary.rule">
      <field name="name">Seguro Cesantía Empleador</field>
      <field name="code">SC_EMPL</field>
      <field name="sequence">40</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute">
        <![CDATA[
                    result = 0.0
                    wage = (contract.wage or 0.0) if contract else 0.0
                    indic = payslip.indicadores_id if payslip else False

                    # Tope SC en pesos
                    if indic and indic.tope_imponible_seguro_cesantia and indic.uf:
                        tope = indic.tope_imponible_seguro_cesantia * indic.uf
                        if wage > tope:
                            wage = tope

                    tasa = (indic.contrato_plazo_indefinido_empleador if (indic and indic.contrato_plazo_indefinido_empleador) else 0.0)
                    # Nota: si quieres tratarlo como costo de empleador (no deducción), deja positivo:
                    # result = (wage * (tasa / 100.0))
                    # Si prefieres como deducción (como lo tenías), deja negativo:
                    result = -(wage * (tasa / 100.0))
                            ]]>
      </field>
    </record>

    <!-- Colación -->
    <record id="hr_salary_rule_chile_colacion" model="hr.salary.rule">
      <field name="name">Colación</field>
      <field name="code">COLACION</field>
      <field name="sequence">45</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute">
        <![CDATA[
            result = (contract.colacion or 0.0) if contract else 0.0
        ]]>
      </field>
    </record>

    <!-- Movilización -->
    <record id="hr_salary_rule_chile_movilizacion" model="hr.salary.rule">
      <field name="name">Movilización</field>
      <field name="code">MOVILIZACION</field>
      <field name="sequence">50</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute">
        <![CDATA[
            result = (contract.movilizacion or 0.0) if contract else 0.0
        ]]>
      </field>
    </record>

    <!-- Asignación Familiar (usa monto tramo A * cargas; ajusta si calculas por tramos de renta) -->
    <record id="hr_salary_rule_chile_asig_familiar" model="hr.salary.rule">
      <field name="name">Asignación Familiar</field>
      <field name="code">ASIGFAM</field>
      <field name="sequence">55</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">python</field>
      <field name="condition_python">
        <![CDATA[
                result = bool(employee and getattr(employee, 'family_dependents', 0) > 0)
        ]]>
      </field>
      <field name="amount_python_compute">
        <![CDATA[
                indic = payslip.indicadores_id if payslip else False
                cargas = getattr(employee, 'family_dependents', 0) if employee else 0
                monto = (indic.asignacion_familiar_monto_a if (indic and indic.asignacion_familiar_monto_a) else 0.0)
                result = monto * cargas
        ]]>
      </field>
    </record>

  </data>
</odoo>
