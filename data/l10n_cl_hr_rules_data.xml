<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data noupdate="0">

    <!-- Sueldo Base -->
    <record id="hr_salary_rule_chile_sueldo_base" model="hr.salary.rule">
      <field name="name">Sueldo Base</field>
      <field name="code">SUELDO</field>
      <field name="sequence">10</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute"><![CDATA[
result = (contract.wage or 0.0) if contract else 0.0
      ]]></field>
    </record>

    <!-- Gratificación Legal -->
    <record id="hr_salary_rule_chile_gratificacion" model="hr.salary.rule">
      <field name="name">Gratificación Legal</field>
      <field name="code">GRAT</field>
      <field name="sequence">15</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="condition_select">python</field>
      <field name="condition_python"><![CDATA[
result = bool(payslip and payslip.indicadores_id and payslip.indicadores_id.gratificacion_legal)
      ]]></field>
      <field name="amount_select">code</field>
      <field name="amount_python_compute"><![CDATA[
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

grat = 0.0
if indic and indic.gratificacion_legal:
    base25 = wage * 0.25
    tope = (indic.utm * 4.75) if (indic.utm) else 0.0
    if tope == 0.0 or base25 <= tope:
        grat = base25
    else:
        grat = tope

result = grat
      ]]></field>
    </record>

    <!-- AFP (trabajador, según AFP del contrato) -->
    <record id="hr_salary_rule_chile_afp" model="hr.salary.rule">
      <field name="name">AFP</field>
      <field name="code">AFP</field>
      <field name="sequence">20</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">python</field>
      <field name="condition_python"><![CDATA[
# No calcular AFP si el contrato está marcado como sin_afp
result = not (contract and contract.sin_afp)
      ]]></field>
      <field name="amount_python_compute"><![CDATA[
result = 0.0
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# Gratificación legal (mismo cálculo que la regla GRAT)
grat = 0.0
if indic and indic.gratificacion_legal:
    base25 = wage * 0.25
    tope_grat = (indic.utm * 4.75) if (indic.utm) else 0.0
    if tope_grat == 0.0 or base25 <= tope_grat:
        grat = base25
    else:
        grat = tope_grat

# Imponible previsional
imponible = wage + grat

# Tope imponible AFP en pesos
if indic and indic.tope_imponible_afp and indic.uf:
    tope_afp = indic.tope_imponible_afp * indic.uf
    if imponible > tope_afp:
        imponible = tope_afp

# Tasa de AFP desde el contrato
tasa = 0.0
if contract and contract.afp_id and contract.afp_id.rate:
    tasa = contract.afp_id.rate

result = -(imponible * (tasa / 100.0))
      ]]></field>
    </record>

    <!-- SIS (aporte empleador, usa tasa SIS AFP) -->
    <record id="hr_salary_rule_chile_sis" model="hr.salary.rule">
      <field name="name">SIS Empleador</field>
      <field name="code">SIS</field>
      <field name="sequence">25</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">python</field>
      <field name="condition_python"><![CDATA[
# Permite desactivar SIS por contrato si está marcado sin_afp_sis
result = not (contract and contract.sin_afp_sis)
      ]]></field>
      <field name="amount_python_compute"><![CDATA[
result = 0.0
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# Gratificación legal
grat = 0.0
if indic and indic.gratificacion_legal:
    base25 = wage * 0.25
    tope_grat = (indic.utm * 4.75) if (indic.utm) else 0.0
    if tope_grat == 0.0 or base25 <= tope_grat:
        grat = base25
    else:
        grat = tope_grat

imponible = wage + grat

# Tope AFP
if indic and indic.tope_imponible_afp and indic.uf:
    tope_afp = indic.tope_imponible_afp * indic.uf
    if imponible > tope_afp:
        imponible = tope_afp

tasa = 0.0
if contract and contract.afp_id and contract.afp_id.sis:
    tasa = contract.afp_id.sis
elif indic and indic.tasa_sis_capital:
    tasa = indic.tasa_sis_capital

# Aporte empleador (no se usa en NETO)
result = -(imponible * (tasa / 100.0))
      ]]></field>
    </record>

    <!-- Salud (Fonasa / Isapre) -->
    <record id="hr_salary_rule_chile_salud" model="hr.salary.rule">
      <field name="name">Salud</field>
      <field name="code">SALUD</field>
      <field name="sequence">30</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute"><![CDATA[
result = 0.0
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# Base imponible: sueldo + gratificación legal
grat = 0.0
if indic and indic.gratificacion_legal:
    base25 = wage * 0.25
    tope_grat = (indic.utm * 4.75) if (indic.utm) else 0.0
    if tope_grat == 0.0 or base25 <= tope_grat:
        grat = base25
    else:
        grat = tope_grat

imponible = wage + grat

# Tope Salud en UF
if indic and indic.tope_imponible_salud and indic.uf:
    tope_salud = indic.tope_imponible_salud * indic.uf
    if imponible > tope_salud:
        imponible = tope_salud

# Isapre / Fonasa
if contract and contract.isapre_id:
    # Isapre
    if contract.isapre_cuenta_propia:
        result = 0.0
    else:
        plan = contract.isapre_cotizacion_uf or 0.0
        if contract.isapre_moneda == 'uf':
            if indic and indic.uf:
                plan = plan * indic.uf
            else:
                plan = 0.0
        result = -plan
else:
    # Fonasa
    tasa = 7.0
    if indic and indic.fonasa:
        tasa = indic.fonasa
    result = -(imponible * (tasa / 100.0))
      ]]></field>
    </record>

    <!-- Seguro Cesantía Trabajador (AFC) -->
    <record id="hr_salary_rule_chile_sc_trabajador" model="hr.salary.rule">
      <field name="name">Seguro Cesantía Trabajador</field>
      <field name="code">SC_TRAB</field>
      <field name="sequence">35</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">python</field>
      <field name="condition_python"><![CDATA[
# No AFC trabajador para pensionados o sin AFP
result = not (contract and (contract.pension or contract.sin_afp))
      ]]></field>
      <field name="amount_python_compute"><![CDATA[
result = 0.0
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# Gratificación legal
grat = 0.0
if indic and indic.gratificacion_legal:
    base25 = wage * 0.25
    tope_grat = (indic.utm * 4.75) if (indic.utm) else 0.0
    if tope_grat == 0.0 or base25 <= tope_grat:
        grat = base25
    else:
        grat = tope_grat

imponible = wage + grat

# Tope AFC
if indic and indic.tope_imponible_seguro_cesantia and indic.uf:
    tope_sc = indic.tope_imponible_seguro_cesantia * indic.uf
    if imponible > tope_sc:
        imponible = tope_sc

# Tipo de contrato (indefinido / plazo_fijo)
tipo_contrato = getattr(contract, 'tipo_contrato', 'indefinido') if contract else 'indefinido'

tasa = 0.0
if indic:
    if tipo_contrato == 'indefinido':
        tasa = getattr(indic, 'contrato_plazo_indefinido_trabajador', 0.0)
    elif tipo_contrato == 'plazo_fijo':
        # trabajador plazo fijo: usualmente 0%
        tasa = getattr(indic, 'contrato_plazo_fijo_trabajador', 0.0)

result = -(imponible * (tasa / 100.0))
      ]]></field>
    </record>

    <!-- Seguro Cesantía Empleador (AFC Empleador) -->
    <record id="hr_salary_rule_chile_sc_empleador" model="hr.salary.rule">
      <field name="name">Seguro Cesantía Empleador</field>
      <field name="code">SC_EMPL</field>
      <field name="sequence">40</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">python</field>
      <field name="condition_python"><![CDATA[
# Se puede desactivar en caso de exención específica, si se define un flag en contrato
result = True
      ]]></field>
      <field name="amount_python_compute"><![CDATA[
result = 0.0
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# Gratificación legal
grat = 0.0
if indic and indic.gratificacion_legal:
    base25 = wage * 0.25
    tope_grat = (indic.utm * 4.75) if (indic.utm) else 0.0
    if tope_grat == 0.0 or base25 <= tope_grat:
        grat = base25
    else:
        grat = tope_grat

imponible = wage + grat

# Tope AFC
if indic and indic.tope_imponible_seguro_cesantia and indic.uf:
    tope_sc = indic.tope_imponible_seguro_cesantia * indic.uf
    if imponible > tope_sc:
        imponible = tope_sc

# Tipo de contrato (indefinido / plazo_fijo)
tipo_contrato = getattr(contract, 'tipo_contrato', 'indefinido') if contract else 'indefinido'

tasa = 0.0
if indic:
    if tipo_contrato == 'indefinido':
        # típicamente 2,4% empleador
        tasa = getattr(indic, 'contrato_plazo_indefinido_empleador', 0.0)
    elif tipo_contrato == 'plazo_fijo':
        # típicamente 3% empleador plazo fijo
        tasa = getattr(indic, 'contrato_plazo_fijo_empleador', 0.0)

result = -(imponible * (tasa / 100.0))
      ]]></field>
    </record>

    <!-- Colación (no imponible) -->
    <record id="hr_salary_rule_chile_colacion" model="hr.salary.rule">
      <field name="name">Colación</field>
      <field name="code">COLACION</field>
      <field name="sequence">45</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute"><![CDATA[
result = (contract.colacion or 0.0) if contract else 0.0
      ]]></field>
    </record>

    <!-- Movilización (no imponible) -->
    <record id="hr_salary_rule_chile_movilizacion" model="hr.salary.rule">
      <field name="name">Movilización</field>
      <field name="code">MOVILIZACION</field>
      <field name="sequence">50</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute"><![CDATA[
result = (contract.movilizacion or 0.0) if contract else 0.0
      ]]></field>
    </record>

    <!-- Asignación Familiar (no imponible, con tramos) -->
    <record id="hr_salary_rule_chile_asig_familiar" model="hr.salary.rule">
      <field name="name">Asignación Familiar</field>
      <field name="code">ASIGFAM</field>
      <field name="sequence">55</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">python</field>
      <field name="condition_python"><![CDATA[
result = bool(contract and (
    contract.carga_familiar or contract.carga_familiar_maternal or contract.carga_familiar_invalida
))
      ]]></field>
      <field name="amount_python_compute"><![CDATA[
indic = payslip.indicadores_id if payslip else False
if not (contract and indic):
    result = 0.0
else:
    wage = (contract.wage or 0.0)
    # Gratificación legal
    grat = 0.0
    if indic.gratificacion_legal:
        base25 = wage * 0.25
        tope_grat = (indic.utm * 4.75) if (indic.utm) else 0.0
        if tope_grat == 0.0 or base25 <= tope_grat:
            grat = base25
        else:
            grat = tope_grat

    imponible = wage + grat

    cargas = (contract.carga_familiar or 0) \
           + (contract.carga_familiar_maternal or 0) \
           + (contract.carga_familiar_invalida or 0)

    monto_carga = 0.0
    renta = imponible

    if renta <= (indic.asignacion_familiar_primero or 0.0):
        monto_carga = indic.asignacion_familiar_monto_a or 0.0
    elif renta <= (indic.asignacion_familiar_segundo or 0.0):
        monto_carga = indic.asignacion_familiar_monto_b or 0.0
    elif renta <= (indic.asignacion_familiar_tercer or 0.0):
        monto_carga = indic.asignacion_familiar_monto_c or 0.0
    else:
        monto_carga = 0.0

    result = monto_carga * cargas
      ]]></field>
    </record>

    <!-- Total Bruto (haberes imp + no imp) -->
    <record id="hr_salary_rule_chile_bruto" model="hr.salary.rule">
      <field name="name">Bruto</field>
      <field name="code">BRUTO</field>
      <field name="sequence">900</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="condition_select">none</field>
      <field name="amount_select">code</field>
      <field name="amount_python_compute"><![CDATA[
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# Gratificación legal
grat = 0.0
if indic and indic.gratificacion_legal:
    base25 = wage * 0.25
    tope_grat = (indic.utm * 4.75) if (indic.utm) else 0.0
    if tope_grat == 0.0 or base25 <= tope_grat:
        grat = base25
    else:
        grat = tope_grat

colacion = (contract.colacion or 0.0) if contract else 0.0
mov = (contract.movilizacion or 0.0) if contract else 0.0

# Asignación familiar (mismo cálculo que regla ASIGFAM, simplificado)
asigfam = 0.0
if contract and indic and (
    contract.carga_familiar or contract.carga_familiar_maternal or contract.carga_familiar_invalida
):
    imponible_af = wage + grat
    cargas = (contract.carga_familiar or 0) \
           + (contract.carga_familiar_maternal or 0) \
           + (contract.carga_familiar_invalida or 0)
    monto_carga = 0.0
    renta = imponible_af
    if renta <= (indic.asignacion_familiar_primero or 0.0):
        monto_carga = indic.asignacion_familiar_monto_a or 0.0
    elif renta <= (indic.asignacion_familiar_segundo or 0.0):
        monto_carga = indic.asignacion_familiar_monto_b or 0.0
    elif renta <= (indic.asignacion_familiar_tercer or 0.0):
        monto_carga = indic.asignacion_familiar_monto_c or 0.0
    asigfam = monto_carga * cargas

result = wage + grat + colacion + mov + asigfam
      ]]></field>
    </record>

    <!-- Salario Neto (líquido a pagar) -->
    <record id="hr_salary_rule_chile_neto" model="hr.salary.rule">
      <field name="name">Salario neto</field>
      <field name="code">NETO</field>
      <field name="sequence">910</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="condition_select">none</field>
      <field name="amount_select">code</field>
      <field name="amount_python_compute"><![CDATA[
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# ===== HABERES =====
grat = 0.0
if indic and indic.gratificacion_legal:
    base25 = wage * 0.25
    tope_grat = (indic.utm * 4.75) if (indic.utm) else 0.0
    if tope_grat == 0.0 or base25 <= tope_grat:
        grat = base25
    else:
        grat = tope_grat

colacion = (contract.colacion or 0.0) if contract else 0.0
mov = (contract.movilizacion or 0.0) if contract else 0.0

# Asignación familiar
asigfam = 0.0
if contract and indic and (
    contract.carga_familiar or contract.carga_familiar_maternal or contract.carga_familiar_invalida
):
    imponible_af = wage + grat
    cargas = (contract.carga_familiar or 0) \
           + (contract.carga_familiar_maternal or 0) \
           + (contract.carga_familiar_invalida or 0)
    monto_carga = 0.0
    renta = imponible_af
    if renta <= (indic.asignacion_familiar_primero or 0.0):
        monto_carga = indic.asignacion_familiar_monto_a or 0.0
    elif renta <= (indic.asignacion_familiar_segundo or 0.0):
        monto_carga = indic.asignacion_familiar_monto_b or 0.0
    elif renta <= (indic.asignacion_familiar_tercer or 0.0):
        monto_carga = indic.asignacion_familiar_monto_c or 0.0
    asigfam = monto_carga * cargas

bruto = wage + grat + colacion + mov + asigfam

# ===== BASE IMPONIBLE COMÚN =====
imponible = wage + grat

# Tope AFP
imponible_afp = imponible
if indic and indic.tope_imponible_afp and indic.uf:
    tope_afp = indic.tope_imponible_afp * indic.uf
    if imponible_afp > tope_afp:
        imponible_afp = tope_afp

# Tope Salud
imponible_salud = imponible
if indic and indic.tope_imponible_salud and indic.uf:
    tope_salud = indic.tope_imponible_salud * indic.uf
    if imponible_salud > tope_salud:
        imponible_salud = tope_salud

# Tope AFC
imponible_sc = imponible
if indic and indic.tope_imponible_seguro_cesantia and indic.uf:
    tope_sc = indic.tope_imponible_seguro_cesantia * indic.uf
    if imponible_sc > tope_sc:
        imponible_sc = tope_sc

# ===== DESCUENTOS TRABAJADOR =====

# AFP
afp = 0.0
if not (contract and contract.sin_afp):
    tasa_afp = 0.0
    if contract and contract.afp_id and contract.afp_id.rate:
        tasa_afp = contract.afp_id.rate
    afp = -(imponible_afp * (tasa_afp / 100.0))

# Salud
salud = 0.0
if contract and contract.isapre_id:
    if not contract.isapre_cuenta_propia:
        plan = contract.isapre_cotizacion_uf or 0.0
        if contract.isapre_moneda == 'uf':
            if indic and indic.uf:
                plan = plan * indic.uf
            else:
                plan = 0.0
        salud = -plan
else:
    tasa_salud = 7.0
    if indic and indic.fonasa:
        tasa_salud = indic.fonasa
    salud = -(imponible_salud * (tasa_salud / 100.0))

# AFC trabajador
afc_trab = 0.0
if not (contract and (contract.pension or contract.sin_afp)):
    tipo_contrato = getattr(contract, 'tipo_contrato', 'indefinido') if contract else 'indefinido'
    tasa_sc_trab = 0.0
    if indic:
        if tipo_contrato == 'indefinido':
            tasa_sc_trab = getattr(indic, 'contrato_plazo_indefinido_trabajador', 0.0)
        elif tipo_contrato == 'plazo_fijo':
            tasa_sc_trab = getattr(indic, 'contrato_plazo_fijo_trabajador', 0.0)
    afc_trab = -(imponible_sc * (tasa_sc_trab / 100.0))

# (OJO: SIS y AFC empleador NO se incluyen en el neto)
result = bruto + afp + salud + afc_trab
      ]]></field>
    </record>

  </data>
</odoo>
