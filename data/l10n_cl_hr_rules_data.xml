<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data noupdate="0">

    <!-- Sueldo Base -->
    <record id="hr_salary_rule_chile_sueldo_base" model="hr.salary.rule">
      <field name="name">Sueldo Base</field>
      <field name="code">SUELDO</field>
      <field name="sequence">10</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute"><![CDATA[
result = (contract.wage or 0.0) if contract else 0.0
      ]]></field>
    </record>

    <!-- Gratificación Legal -->
    <record id="hr_salary_rule_chile_gratificacion" model="hr.salary.rule">
      <field name="name">Gratificación Legal</field>
      <field name="code">GRATIFICACION</field>
      <field name="sequence">15</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="condition_select">python</field>
      <field name="condition_python"><![CDATA[
result = bool(payslip and payslip.indicadores_id and payslip.indicadores_id.gratificacion_legal)
      ]]></field>
      <field name="amount_select">code</field>
      <field name="amount_python_compute"><![CDATA[
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# 25% del sueldo con tope 4.75 UTM del periodo
base25 = wage * 0.25
tope = (indic.utm * 4.75) if (indic and indic.utm) else 0.0

result = base25 if (tope == 0.0 or base25 <= tope) else tope
      ]]></field>
    </record>

    <!-- AFP -->
    <record id="hr_salary_rule_chile_afp" model="hr.salary.rule">
      <field name="name">AFP</field>
      <field name="code">AFP</field>
      <field name="sequence">20</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute"><![CDATA[
result = 0.0
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# Tope AFP en pesos (UF * valor UF)
if indic and indic.tope_imponible_afp and indic.uf:
    tope = indic.tope_imponible_afp * indic.uf
    if wage > tope:
        wage = tope

tasa = (indic.tasa_afp_capital if (indic and indic.tasa_afp_capital) else 0.0)
result = -(wage * (tasa / 100.0))
      ]]></field>
    </record>

    <!-- SIS -->
    <record id="hr_salary_rule_chile_sis" model="hr.salary.rule">
      <field name="name">SIS</field>
      <field name="code">SIS</field>
      <field name="sequence">25</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute"><![CDATA[
result = 0.0
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# Tope AFP en pesos
if indic and indic.tope_imponible_afp and indic.uf:
    tope = indic.tope_imponible_afp * indic.uf
    if wage > tope:
        wage = tope

tasa = (indic.tasa_sis_capital if (indic and indic.tasa_sis_capital) else 0.0)
result = -(wage * (tasa / 100.0))
      ]]></field>
    </record>

    <!-- Salud (Fonasa/Isapre, con fallback 7%) -->
    <record id="hr_salary_rule_chile_salud" model="hr.salary.rule">
      <field name="name">Salud</field>
      <field name="code">SALUD</field>
      <field name="sequence">30</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute"><![CDATA[
result = 0.0
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# Tope Salud en pesos
if indic and indic.tope_imponible_salud and indic.uf:
    tope = indic.tope_imponible_salud * indic.uf
    if wage > tope:
        wage = tope

# Fonasa: si no viene tasa en indicadores, usar 7% por defecto
tasa = 7.0
if indic and indic.fonasa:
    tasa = indic.fonasa

result = -(wage * (tasa / 100.0))
      ]]></field>
    </record>

    <!-- Seguro Cesantía Trabajador -->
    <record id="hr_salary_rule_chile_sc_trabajador" model="hr.salary.rule">
      <field name="name">Seguro Cesantía Trabajador</field>
      <field name="code">SC_TRAB</field>
      <field name="sequence">35</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute"><![CDATA[
result = 0.0
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# Tope SC en pesos
if indic and indic.tope_imponible_seguro_cesantia and indic.uf:
    tope = indic.tope_imponible_seguro_cesantia * indic.uf
    if wage > tope:
        wage = tope

tasa = (indic.contrato_plazo_indefinido_trabajador if (indic and indic.contrato_plazo_indefinido_trabajador) else 0.0)
result = -(wage * (tasa / 100.0))
      ]]></field>
    </record>

    <!-- Seguro Cesantía Empleador -->
    <record id="hr_salary_rule_chile_sc_empleador" model="hr.salary.rule">
      <field name="name">Seguro Cesantía Empleador</field>
      <field name="code">SC_EMPL</field>
      <field name="sequence">40</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute"><![CDATA[
result = 0.0
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# Tope SC en pesos
if indic and indic.tope_imponible_seguro_cesantia and indic.uf:
    tope = indic.tope_imponible_seguro_cesantia * indic.uf
    if wage > tope:
        wage = tope

tasa = (indic.contrato_plazo_indefinido_empleador if (indic and indic.contrato_plazo_indefinido_empleador) else 0.0)
# Tratado como deducción (si lo quieres como costo empleador deja positivo)
result = -(wage * (tasa / 100.0))
      ]]></field>
    </record>

    <!-- Colación -->
    <record id="hr_salary_rule_chile_colacion" model="hr.salary.rule">
      <field name="name">Colación</field>
      <field name="code">COLACION</field>
      <field name="sequence">45</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute"><![CDATA[
result = (contract.colacion or 0.0) if contract else 0.0
      ]]></field>
    </record>

    <!-- Movilización -->
    <record id="hr_salary_rule_chile_movilizacion" model="hr.salary.rule">
      <field name="name">Movilización</field>
      <field name="code">MOVILIZACION</field>
      <field name="sequence">50</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="amount_select">code</field>
      <field name="condition_select">none</field>
      <field name="amount_python_compute"><![CDATA[
result = (contract.movilizacion or 0.0) if contract else 0.0
      ]]></field>
    </record>

  <!-- Asignación Familiar -->
  <record id="hr_salary_rule_chile_asig_familiar" model="hr.salary.rule">
    <field name="name">Asignación Familiar</field>
    <field name="code">ASIGFAM</field>
    <field name="sequence">55</field>
    <field name="category_id" ref="hr_salary_rule_category_chile"/>
    <field name="struct_id" ref="hr_pay_structure_chile"/>
    <field name="amount_select">code</field>

    <!-- Condición: que el contrato tenga cargas familiares > 0 -->
    <field name="condition_select">python</field>
    <field name="condition_python"><![CDATA[
result = bool(contract and contract.carga_familiar and contract.carga_familiar > 0)
    ]]></field>

    <field name="amount_python_compute"><![CDATA[
indic = payslip.indicadores_id if payslip else False

# número de cargas desde el contrato
cargas = contract.carga_familiar if (contract and contract.carga_familiar) else 0

# monto por carga (tramo A, ajusta si usas otro)
monto = indic.asignacion_familiar_monto_a if (indic and indic.asignacion_familiar_monto_a) else 0.0

result = monto * cargas
    ]]></field>
  </record>

    <!-- Total Bruto -->
  <record id="hr_salary_rule_chile_bruto" model="hr.salary.rule">
      <field name="name">Bruto</field>
      <field name="code">BRUTO</field>
      <field name="sequence">900</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="condition_select">none</field>
      <field name="amount_select">code</field>
      <field name="amount_python_compute"><![CDATA[
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# Sueldo base
sueldo = wage

# Gratificación legal
grat = 0.0
if indic and indic.gratificacion_legal:
    base25 = wage * 0.25
    tope = (indic.utm * 4.75) if indic.utm else 0.0
    grat = base25 if (tope == 0.0 or base25 <= tope) else tope

# Colación
colacion = contract.colacion if (contract and contract.colacion) else 0.0

# Movilización
mov = contract.movilizacion if (contract and contract.movilizacion) else 0.0

# Asignación familiar (mismas reglas que ASIGFAM)
cargas = contract.carga_familiar if (contract and contract.carga_familiar) else 0
monto_asig = indic.asignacion_familiar_monto_a if (indic and indic.asignacion_familiar_monto_a) else 0.0
asigfam = monto_asig * cargas

result = sueldo + grat + colacion + mov + asigfam
      ]]></field>
    </record>

    <!-- Salario Neto -->
  <record id="hr_salary_rule_chile_neto" model="hr.salary.rule">
      <field name="name">Salario neto</field>
      <field name="code">NETO</field>
      <field name="sequence">910</field>
      <field name="category_id" ref="hr_salary_rule_category_chile"/>
      <field name="struct_id" ref="hr_pay_structure_chile"/>
      <field name="condition_select">none</field>
      <field name="amount_select">code</field>
      <field name="amount_python_compute"><![CDATA[
wage = (contract.wage or 0.0) if contract else 0.0
indic = payslip.indicadores_id if payslip else False

# ===== BRUTO (mismo cálculo que regla BRUTO) =====
sueldo = wage

grat = 0.0
if indic and indic.gratificacion_legal:
    base25 = wage * 0.25
    tope = (indic.utm * 4.75) if indic.utm else 0.0
    grat = base25 if (tope == 0.0 or base25 <= tope) else tope

colacion = contract.colacion if (contract and contract.colacion) else 0.0
mov = contract.movilizacion if (contract and contract.movilizacion) else 0.0

cargas = contract.carga_familiar if (contract and contract.carga_familiar) else 0
monto_asig = indic.asignacion_familiar_monto_a if (indic and indic.asignacion_familiar_monto_a) else 0.0
asigfam = monto_asig * cargas

bruto = sueldo + grat + colacion + mov + asigfam

# ===== DESCUENTOS LEGALES TRABAJADOR =====

# AFP
afp_base = wage
if indic and indic.tope_imponible_afp and indic.uf:
    tope_afp = indic.tope_imponible_afp * indic.uf
    if afp_base > tope_afp:
        afp_base = tope_afp
tasa_afp = indic.tasa_afp_capital if (indic and indic.tasa_afp_capital) else 0.0
afp = -(afp_base * (tasa_afp / 100.0))

# SIS
sis_base = wage
if indic and indic.tope_imponible_afp and indic.uf:
    tope_afp = indic.tope_imponible_afp * indic.uf
    if sis_base > tope_afp:
        sis_base = tope_afp
tasa_sis = indic.tasa_sis_capital if (indic and indic.tasa_sis_capital) else 0.0
sis = -(sis_base * (tasa_sis / 100.0))

# Salud
salud_base = wage
if indic and indic.tope_imponible_salud and indic.uf:
    tope_salud = indic.tope_imponible_salud * indic.uf
    if salud_base > tope_salud:
        salud_base = tope_salud
tasa_salud = 7.0
if indic and indic.fonasa:
    tasa_salud = indic.fonasa
salud = -(salud_base * (tasa_salud / 100.0))

# Seguro cesantía trabajador
sc_base = wage
if indic and indic.tope_imponible_seguro_cesantia and indic.uf:
    tope_sc = indic.tope_imponible_seguro_cesantia * indic.uf
    if sc_base > tope_sc:
        sc_base = tope_sc
tasa_sc = indic.contrato_plazo_indefinido_trabajador if (indic and indic.contrato_plazo_indefinido_trabajador) else 0.0
sc_trab = -(sc_base * (tasa_sc / 100.0))

# ===== NETO =====
result = bruto + afp + sis + salud + sc_trab
      ]]></field>
  </record>



  </data>
</odoo>
